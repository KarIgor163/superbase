#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะฝะฐัััะพะนะบะธ ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ัะตะทะตัะฒะฝะพะณะพ ะบะพะฟะธัะพะฒะฐะฝะธั Supabase ัะตัะตะท cron
set -e

echo "๐ ะะฐัััะพะนะบะฐ ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ัะตะทะตัะฒะฝะพะณะพ ะบะพะฟะธัะพะฒะฐะฝะธั Supabase..."

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั sudo ะฟัะฐะฒ
if [ "$(id -u)" != "0" ]; then
   echo "ะญัะพั ัะบัะธะฟั ััะตะฑัะตั ะฟัะธะฒะธะปะตะณะธะน ััะฟะตัะฟะพะปัะทะพะฒะฐัะตะปั. ะัะฟะพะปัะทัะนัะต sudo."
   exit 1
fi

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ัะฐะนะปะพะฒ ัะบัะธะฟัะพะฒ
BACKUP_SCRIPT="/opt/supabase-scripts/backup_supabase.sh"
SCRIPTS_DIR="/opt/supabase-scripts"

# ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ะดะปั ัะบัะธะฟัะพะฒ, ะตัะปะธ ะตั ะฝะตั
if [ ! -d "$SCRIPTS_DIR" ]; then
    echo "๐ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ะดะปั ัะบัะธะฟัะพะฒ..."
    mkdir -p $SCRIPTS_DIR
fi

# ะะพะฟะธัะพะฒะฐะฝะธะต ัะบัะธะฟัะพะฒ ะฒ ะดะธัะตะบัะพัะธั
echo "๐ ะะพะฟะธัะพะฒะฐะฝะธะต ัะบัะธะฟัะพะฒ..."
cp backup_supabase.sh $BACKUP_SCRIPT
chmod +x $BACKUP_SCRIPT

# ะะธัะตะบัะพัะธั ะดะปั ะปะพะณะพะฒ
LOG_DIR="/var/log/supabase"
mkdir -p $LOG_DIR

# ะัะฑะพั ัะฐััะพัั ะทะฐะฟััะบะฐ ะฑัะบะฐะฟะพะฒ
echo "๐ ะัะฑะตัะธัะต ัะฐััะพัั ัะพะทะดะฐะฝะธั ัะตะทะตัะฒะฝัั ะบะพะฟะธะน:"
echo "1) ะะถะตะดะฝะตะฒะฝะพ"
echo "2) ะะถะตะฝะตะดะตะปัะฝะพ"
echo "3) ะะถะตะผะตัััะฝะพ"

read -p "ะะฐั ะฒัะฑะพั (1-3): " BACKUP_FREQUENCY

case $BACKUP_FREQUENCY in
    1)
        # ะะถะตะดะฝะตะฒะฝัะน ะฑัะบะฐะฟ ะฒ 2:00
        CRON_SCHEDULE="0 2 * * *"
        FREQUENCY_DESC="ะตะถะตะดะฝะตะฒะฝะพ ะฒ 2:00"
        ;;
    2)
        # ะะถะตะฝะตะดะตะปัะฝัะน ะฑัะบะฐะฟ ะฒ ะฒะพัะบัะตัะตะฝัะต ะฒ 3:00
        CRON_SCHEDULE="0 3 * * 0"
        FREQUENCY_DESC="ะตะถะตะฝะตะดะตะปัะฝะพ (ะฒะพัะบัะตัะตะฝัะต ะฒ 3:00)"
        ;;
    3)
        # ะะถะตะผะตัััะฝัะน ะฑัะบะฐะฟ ะฒ ะฟะตัะฒัะน ะดะตะฝั ะผะตัััะฐ ะฒ 4:00
        CRON_SCHEDULE="0 4 1 * *"
        FREQUENCY_DESC="ะตะถะตะผะตัััะฝะพ (1-ะต ัะธัะปะพ ะฒ 4:00)"
        ;;
    *)
        echo "โ ะะตะบะพััะตะบัะฝัะน ะฒัะฑะพั. ะฃััะฐะฝะพะฒะบะฐ ะตะถะตะดะฝะตะฒะฝะพะณะพ ะฑัะบะฐะฟะฐ ะฟะพ ัะผะพะปัะฐะฝะธั."
        CRON_SCHEDULE="0 2 * * *"
        FREQUENCY_DESC="ะตะถะตะดะฝะตะฒะฝะพ ะฒ 2:00"
        ;;
esac

# ะะฐัััะพะนะบะฐ ัะพัะฐัะธะธ ะปะพะณะพะฒ (ััะฐะฝะธัั ะปะพะณะธ ะทะฐ ะฟะพัะปะตะดะฝะธะต 7 ะดะฝะตะน)
cat > /etc/logrotate.d/supabase << EOL
$LOG_DIR/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 root root
}
EOL

# ะะพะฑะฐะฒะปะตะฝะธะต ะทะฐะดะฐะฝะธั ะฒ cron
CRON_JOB="$CRON_SCHEDULE $BACKUP_SCRIPT > $LOG_DIR/backup_\$(date +\%Y\%m\%d).log 2>&1"

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ัะฐะบะพะณะพ ะถะต ะทะฐะดะฐะฝะธั ะฒ crontab
EXISTING_JOB=$(crontab -l 2>/dev/null | grep -F "$BACKUP_SCRIPT")

if [ -n "$EXISTING_JOB" ]; then
    echo "โ๏ธ ะฃะถะต ัััะตััะฒัะตั ะทะฐะดะฐะฝะธะต ะดะปั ัะตะทะตัะฒะฝะพะณะพ ะบะพะฟะธัะพะฒะฐะฝะธั. ะะฑะฝะพะฒะปัะตะผ..."
    (crontab -l 2>/dev/null | grep -v "$BACKUP_SCRIPT" ; echo "$CRON_JOB") | crontab -
else
    (crontab -l 2>/dev/null ; echo "$CRON_JOB") | crontab -
fi

echo "โ ะะฐัััะพะนะบะฐ ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ัะตะทะตัะฒะฝะพะณะพ ะบะพะฟะธัะพะฒะฐะฝะธั ะทะฐะฒะตััะตะฝะฐ!"
echo "๐ ะะตะทะตัะฒะฝัะต ะบะพะฟะธะธ ะฑัะดัั ัะพะทะดะฐะฒะฐัััั $FREQUENCY_DESC"
echo "๐ ะัะบะฐะฟั ััะฐะฝัััั ะฒ: /opt/supabase/backups"
echo "๐ ะะพะณะธ ะฑัะบะฐะฟะพะฒ: $LOG_DIR" 